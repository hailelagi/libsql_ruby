name: libsql_ruby
concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true
on:
  push:
    branches:
      - main

  pull_request:

jobs:
  rubocop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true
      - run: bundle install
      - run: bundle exec rake compile
      - run: bundle exec rake rubocop

  test:
    needs: [rubocop]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oxidize-rb/actions/setup-ruby-and-rust@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          cargo-cache: true
      - name: Run ruby tests
        run: bundle exec rake

      - name: Lint rust
        run: cargo clippy && cargo fmt --check

      - run: |
          sudo apt-get update
          sudo apt-get install -y libc6-dbg
    
      - name: Install and test against Valgrind from source
        run: |
          wget https://sourceware.org/pub/valgrind/valgrind-3.21.0.tar.bz2
          tar xvf valgrind-3.21.0.tar.bz2
          cd valgrind-3.21.0
          ./configure
          make
          sudo make install
          cd ..
          bundle install
          bundle exec rake spec:valgrind

  build:
    needs: [test, rubocop]
    runs-on: ${{matrix.os }}
    name: Ruby ${{ matrix.ruby }}
    strategy:
      matrix:
        # ruby: ["3.0", "3.1", "3.2", "3.3", "head"]
        ruby: ["3.1"]
        # rust: [stable, beta]
        rust: [stable]
        # os: ["ubuntu-latest", "macos-13", "windows-latest"]
        os: ["ubuntu-latest"]
    steps:
    - name: Set up Ruby & Rust
      uses: oxidize-rb/actions/setup-ruby-and-rust@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
        cargo-cache: true
        rubygems: '3.5.15'
    - name: Run the default task
      run: bundle exec rake

  # cruby-package:
  #   runs-on: "ubuntu-latest"
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/cache@v4
  #       with:
  #         path: precompiled/ports/archives
  #         key: archives-ubuntu-${{hashFiles('precompiled/ext/precompiled/extconf.rb')}}
  #     - uses: ruby/setup-ruby@v1
  #       with:
  #         working-directory: precompiled
  #         ruby-version: "3.2"
  #         bundler-cache: true
  #     - run: ./bin/test-gem-build gems ruby
  #       working-directory: precompiled
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: cruby-gem
  #         path: precompiled/gems
  #         retention-days: 1
