name: libsql_ruby
concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true
on:
  push:
    branches:
      - main

  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Ruby ${{ matrix.ruby }}
    strategy:
      matrix:
        ruby:
          - '3.1.0'

    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby & Rust
      uses: oxidize-rb/actions/setup-ruby-and-rust@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
        cargo-cache: true
        rubygems: '3.5.15'
    - name: Run the default task
      run: bundle exec rake

  rubocop:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true
      - run: bundle exec rake rubocop

  build-gem:
    needs: [rubocop, valgrind]
    strategy:
      matrix:
        # ruby: ["3.0", "3.1", "3.2", "3.3", "head"]
        ruby: ["3.1"]
        # rust: [stable, beta]
        rust: [stable]
        # os: ["ubuntu-latest", "macos-13", "windows-latest"]
        os: ["ubuntu-latest"]
    runs-on: ${{matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      # TODO: pls cache my deps
      - run: cargo build -vv --release && cargo test -vv

      - uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: ${{matrix.ruby}}
          bundler-cache: true
          # mingw: "libyaml" # windows
          apt-get: "libyaml-dev" # linux
          brew: "libyaml" # macos

      - run: bundle install && bundle exec rake compile

  valgrind:
    needs: [rubocop]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true
          apt-get: valgrind
      - uses: actions/cache@v4
        with:
          path: ports
          key: ports-ubuntu-${{ hashFiles('ext/libsql/extconf.rb') }}
      - run: bundle exec rake compile
      - run: bundle exec rake spec:valgrind

  # cruby-package:
  #   runs-on: "ubuntu-latest"
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/cache@v4
  #       with:
  #         path: precompiled/ports/archives
  #         key: archives-ubuntu-${{hashFiles('precompiled/ext/precompiled/extconf.rb')}}
  #     - uses: ruby/setup-ruby@v1
  #       with:
  #         working-directory: precompiled
  #         ruby-version: "3.2"
  #         bundler-cache: true
  #     - run: ./bin/test-gem-build gems ruby
  #       working-directory: precompiled
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: cruby-gem
  #         path: precompiled/gems
  #         retention-days: 1
